{% extends 'base.html' %}
{% load static %}
{% load i18n_fallback %}

{% block title %}{% trans "Preferences" %} - {% trans "Basketball Fans" %}{% endblock %}

{% block content %}
<div class="container">
    <div class="preferences-header">
        <h1><i class="fas fa-cog"></i> {% trans "Preferences" %}</h1>
        <p>{% trans "Customize your experience with language and theme settings" %}</p>
    </div>

    <div class="preferences-content">
        <form method="post" class="preferences-form">
            {% csrf_token %}
            
            <div class="form-section">
                <h2><i class="fas fa-language"></i> {% trans "Language Settings" %}</h2>
                <p class="section-description">{% trans "Choose your preferred language for the interface" %}</p>
                
                <div class="form-group">
                    <label for="language">{% trans "Interface Language:" %}</label>
                    <select id="language" name="language" class="form-control">
                        {% for code, name in language_choices %}
                        <option value="{{ code }}" {% if code == current_language %}selected{% endif %}>
                            {{ name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="language-preview">
                    <div class="preview-item">
                        <strong>{% trans "Current Selection:" %}</strong>
                        <span id="current-language-display">
                            {% for code, name in language_choices %}
                                {% if code == current_language %}{{ name }}{% endif %}
                            {% endfor %}
                        </span>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2><i class="fas fa-palette"></i> {% trans "Theme Settings" %}</h2>
                <p class="section-description">{% trans "Choose your preferred color theme" %}</p>
                
                <div class="theme-options">
                    {% for code, name in theme_choices %}
                    <div class="theme-option">
                        <input type="radio" 
                               id="theme-{{ code }}" 
                               name="theme" 
                               value="{{ code }}" 
                               {% if code == current_theme %}checked{% endif %}
                               onchange="previewTheme('{{ code }}')">
                        <label for="theme-{{ code }}" class="theme-label">
                            <div class="theme-circle theme-{{ code }}"></div>
                            <span class="theme-name">{{ name }}</span>
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>



            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">
                    <i class="fas fa-undo"></i>
                    {% trans "Reset All" %}
                </button>
                
                <a href="{% url 'home' %}" class="btn btn-outline">
                    <i class="fas fa-times"></i>
                    {% trans "Cancel" %}
                </a>
            </div>

        </form>
    </div>


</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Action</h3>
            <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="confirmBtn">Confirm</button>
            <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function previewTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    
    if (typeof changeThemeAjax === 'function') {
        changeThemeAjax(theme);
    } else {
        document.cookie = `theme=${theme}; path=/; max-age=31536000`;
        console.log('Theme saved to cookie directly:', theme);
    }
    
    console.log(`Theme changed to ${theme}`);
    
    updateLanguageDisplay();
}

function updateLanguageDisplay() {
    const languageSelect = document.getElementById('language');
    const display = document.getElementById('current-language-display');
    const selectedOption = languageSelect.options[languageSelect.selectedIndex];
    display.textContent = selectedOption.text;
}

document.getElementById('language').addEventListener('change', function() {
    const language = this.value;
    if (language && typeof changeLanguageAjax === 'function') {
        changeLanguageAjax(language);
    } else {
        document.cookie = `django_language=${language}; path=/; max-age=31536000`;
        updateLanguageDisplay();
        setTimeout(() => location.reload(), 1000);
    }
});

function clearAllFavorites() {
    showConfirmModal(
        'Are you sure you want to remove all favorite teams? This action cannot be undone.',
        function() {
            document.cookie = 'favorite_teams=[]; path=/; max-age=0';
            location.reload();
        }
    );
}

function resetToDefaults() {
    document.cookie = 'django_language=; path=/; max-age=0';
    document.cookie = 'theme=; path=/; max-age=0';
    document.cookie = 'favorite_teams=[]; path=/; max-age=0';
    
    document.getElementById('language').value = 'en';
    document.querySelector('input[value="light"]').checked = true;
    previewTheme('light');
    
    console.log('All preferences reset successfully!');
    
    location.reload();
}

function showConfirmModal(message, confirmCallback) {
    document.getElementById('confirmMessage').textContent = message;
    document.getElementById('confirmBtn').onclick = function() {
        confirmCallback();
        closeModal();
    };
    document.getElementById('confirmModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('confirmModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('confirmModal');
    if (event.target === modal) {
        closeModal();
    }
}

let formSubmissionInProgress = false;

document.querySelector('.preferences-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (formSubmissionInProgress) {
        console.log('Form submission in progress, please wait...');
        return false;
    }
    
    console.log('Preferences are saved automatically!');
    return false;
});
</script>
{% endblock %}